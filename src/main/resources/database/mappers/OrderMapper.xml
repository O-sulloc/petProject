<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pj.pet.order.OrderMapper">

 	<select id="orderList" parameterType="OrderVO" resultMap="orderResult">
		SELECT P.*,O.*
		FROM PAY P
		LEFT OUTER JOIN
		ORDERS O
		ON(P.PAYNUM=O.PAYNUM)
		WHERE O.ID =#{id}
	</select>
	
	<resultMap type="OrderVO" id="orderResult">
       <id column="orderNum" property="orderNum"/>
       <result column="id" property="id"/>
       <result column="orderName" property="orderName"/>
       <result column="shipState" property="shipState"/>
       <result column="orderDate" property="orderDate"/>
       <result column="refund" property="refund"/>
       <association property="payVO" javaType="PayVO">
          <id column="payNum" property="payNum"/>
          <result column="totalPrice" property="totalPrice"/>
          <result column="totalCount" property="totalCount"/>
          <result column="arrive" property="arrive"/>
          <result column="recipient" property="recipient"/>
          <result column="recipientPhone" property="recipientPhone"/>
       </association>
    </resultMap> 
   
	<insert id="setAdd" parameterType="OrderVO">
		INSERT INTO ORDERS
		VALUES(null,#{payNum},#{id},#{orderName},0,now(),0)
	</insert>

	<select id="getOrderName" resultType="string">
		SELECT DISTINCT concat(cast(O.ORDERDATE as char), right(concat("00000" ,rowCount), 6)) as ORDERNAME
		FROM ORDERS as OS,
		(SELECT concat(substr(date_format(now(), '%Y-%m-%d'), 1, 10)) as ORDERDATE,
		(SELECT ORDERNUM FROM ORDERS ORDER BY ORDERNUM DESC limit 1) as
		rowCount FROM dual) O;
	</select>
	
	<update id="updateName" parameterType="string">
		UPDATE ORDERS SET ORDERNAME=#{orderName}
	</update>


	<!-- 결제한 디테일 상품 리스트 -->
	<select id="orderDetailList" parameterType="PayVO" resultMap="cartListResult">
		SELECT C.*,P.PRODUCTNAME,P.PRODUCTPRICE,P.RATE,P.PRODUCTCOUNT,PF.*,CR.*
		FROM CARTS C
		LEFT JOIN
		PRODUCTS P
		ON(C.PRODUCTNUM=P.PRODUCTNUM)
		LEFT JOIN
		PRODUCTSFILE PF
		ON(P.PRODUCTNUM=PF.PRODUCTNUM)
		LEFT JOIN
		CARTREFER CR
		ON(C.CARTNUM=CR.CARTNUM)
		WHERE ID =#{id} AND PAYCHECK=1 AND CR.PAYNUM =#{payNum}
	</select>

	<resultMap type="CartVO" id="cartListResult">
		<id column="cartNum" property="cartNum" />
		<result column="id" property="id" />
		<result column="productNum" property="productNum" />
		<result column="productAmount" property="productAmount" />
		<result column="payCheck" property="payCheck" />
		<collection property="productVO" resultMap="ProductVO" />
		<collection property="productFileVOs" resultMap="ProductFileVO" />
		<collection property="cartReferVO" resultMap="CartReferVO" />
	</resultMap>

	<resultMap type="ProductVO" id="ProductVO">
		<id column="productNum" property="productNum" />
		<result column="productPrice" property="productPrice" />
		<result column="productName" property="productName" />
		<result column="productCount" property="productCount" />
		<result column="rate" property="rate" />
	</resultMap>

	<resultMap type="ProductFileVO" id="ProductFileVO">
		<id column="fileNum" property="fileNum" />
		<result column="productNum" property="productNum" />
		<result column="fileName" property="fileName" />
		<result column="oriName" property="oriName" />
	</resultMap>
	
	<resultMap type="CartReferVO" id="CartReferVO">
		<id column="cartreferNum" property="cartreferNum" />
		<result column="cartNum" property="cartNum" />
		<result column="payNum" property="payNum" />
		<result column="paymentKind" property="paymentKind" />
	</resultMap>
	
</mapper>